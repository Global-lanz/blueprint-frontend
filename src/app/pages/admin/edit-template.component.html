<div class="bp-page">
  <div class="bp-container">
    <app-breadcrumb></app-breadcrumb>

    <div class="bp-loading" *ngIf="loading()">
      <div class="bp-spinner"></div>
    </div>

    <div *ngIf="!loading()">
      <div class="bp-flex bp-justify-between bp-items-center bp-mb-2xl">
        <div>
          <div class="bp-flex bp-items-center bp-gap-md bp-mb-sm">
            <h1 style="margin: 0;">{{ templateId ? 'Editar Template de Projeto' : 'Criar Novo Template' }}</h1>
            <span *ngIf="templateId" class="bp-badge" [class.bp-badge-success]="isActive()"
              [class.bp-badge-warning]="!isActive()">
              {{ isActive() ? "Ativo" : "Inativo" }}
            </span>
          </div>
          <p class="bp-text-muted">{{ templateId ? 'Modifique as informa√ß√µes e tarefas do template' : 'Crie um novo
            template de projeto com etapas e tarefas' }}</p>
        </div>
        <div class="bp-flex bp-gap-md">
          <button *ngIf="templateId" type="button" (click)="toggleActive()"
            [class]="isActive() ? 'bp-btn bp-btn-warning' : 'bp-btn bp-btn-success'">
            {{ isActive() ? "üîí Desativar" : "‚úì Ativar" }}
          </button>
          <button type="button" class="bp-btn bp-btn-secondary" (click)="cancel()">
            ‚Üê Voltar
          </button>
        </div>
      </div>

      <div class="bp-card">
        <div class="bp-card-body">
          <form (ngSubmit)="saveTemplate()">
            <!-- Informa√ß√µes B√°sicas -->
            <div class="bp-form-group">
              <label class="bp-label">Nome do Template *</label>
              <input type="text" class="bp-input" [(ngModel)]="templateForm.name" name="name" required />
            </div>

            <div class="bp-form-group">
              <label class="bp-label">Descri√ß√£o</label>
              <app-rich-text-editor [(ngModel)]="templateForm.description" name="description"
                placeholder="Descreva o template..."></app-rich-text-editor>
            </div>

            <!-- Etapas -->
            <div class="bp-mb-lg">
              <div class="bp-flex bp-justify-between bp-items-center bp-mb-md">
                <h4>Etapas do Projeto</h4>
              </div>

              <div *ngFor="let stage of templateForm.stages; let si = index" class="bp-card bp-mb-lg"
                style="border-left: 4px solid #4f46e5;">
                <div class="bp-card-header" style="background: #f5f5ff; cursor: pointer;" (click)="toggleStage(si)">
                  <div class="bp-flex bp-justify-between bp-items-center">
                    <div class="bp-flex bp-items-center bp-gap-sm">
                      <span style="color: #4f46e5; font-size: 0.875rem; width: 1rem;">{{ isStageExpanded(si) ? '‚ñº' : '‚ñ∂'
                        }}</span>
                      <span *ngIf="stage.gemType" [innerHTML]="getGemIcon(stage.gemType)"
                        style="display: flex; align-items: center;"></span>
                      <h4 class="bp-card-title" style="color: #4f46e5; margin: 0;">Etapa #{{ si + 1 }} - {{ stage.name
                        || 'Nova Etapa' }}</h4>
                    </div>
                    <div class="bp-flex bp-gap-sm">
                      <button type="button" class="bp-btn bp-btn-sm bp-btn-secondary"
                        (click)="duplicateStage(si); $event.stopPropagation()" title="Duplicar Etapa">
                        üìã
                      </button>
                      <button type="button" class="bp-btn bp-btn-sm bp-btn-error"
                        (click)="removeStage(si); $event.stopPropagation()" title="Remover Etapa">
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                </div>
                <div class="bp-card-body" *ngIf="isStageExpanded(si)">
                  <div class="bp-form-group">
                    <label class="bp-label">Nome da Etapa *</label>
                    <input type="text" class="bp-input" [(ngModel)]="stage.name" [name]="'stage-name-' + si"
                      placeholder="Ex: Planejamento, Execu√ß√£o, Finaliza√ß√£o..." required />
                  </div>

                  <div class="bp-form-group">
                    <label class="bp-label">Descri√ß√£o da Etapa</label>
                    <app-rich-text-editor [(ngModel)]="stage.description" [name]="'stage-description-' + si"
                      placeholder="Descreva o que ser√° feito nesta etapa..."></app-rich-text-editor>
                  </div>

                  <div class="bp-form-group">
                    <label class="bp-label">Tipo de Pedra *</label>
                    <div class="bp-flex bp-items-center bp-gap-sm">
                      <span *ngIf="stage.gemType" [innerHTML]="getGemIcon(stage.gemType)"
                        style="display: flex; align-items: center;"></span>
                      <select class="bp-input" [(ngModel)]="stage.gemType" [name]="'stage-gemType-' + si" required
                        style="flex: 1;">
                        <option *ngFor="let gem of gemTypes" [value]="gem.value">
                          {{ gem.label }}
                        </option>
                      </select>
                    </div>
                  </div>

                  <!-- Tarefas da Etapa -->
                  <div class="bp-mb-md">
                    <div class="bp-flex bp-justify-between bp-items-center bp-mb-sm">
                      <label class="bp-label">Tarefas desta Etapa</label>
                      <button type="button" class="bp-btn bp-btn-sm bp-btn-secondary" (click)="addTaskToStage(si)">
                        + Tarefa
                      </button>
                    </div>

                    <div *ngFor="let task of stage.tasks; let ti = index" class="bp-card bp-mb-md"
                      style="background: #fafafa;">
                      <div class="bp-card-header" style="background: #f0f0f0; cursor: pointer;"
                        (click)="toggleTask(si, ti)">
                        <div class="bp-flex bp-justify-between bp-items-center">
                          <div class="bp-flex bp-items-center bp-gap-sm">
                            <span style="font-size: 0.75rem; width: 0.8rem;">{{ isTaskExpanded(si, ti) ? '‚ñº' : '‚ñ∂'
                              }}</span>
                            <h5 class="bp-card-title" style="margin: 0;">Tarefa #{{ ti + 1 }} - {{ task.title || 'Nova
                              Tarefa' }}</h5>
                          </div>
                          <div class="bp-flex bp-gap-sm">
                            <button type="button" class="bp-btn bp-btn-sm bp-btn-secondary"
                              (click)="duplicateTask(si, ti); $event.stopPropagation()" title="Duplicar Tarefa">
                              üìã
                            </button>
                            <button type="button" class="bp-btn bp-btn-sm bp-btn-error"
                              (click)="removeTaskFromStage(si, ti); $event.stopPropagation()">
                              ‚úï
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="bp-card-body" *ngIf="isTaskExpanded(si, ti)">
                        <div class="bp-form-group">
                          <label class="bp-label">T√≠tulo da Tarefa *</label>
                          <input type="text" class="bp-input" [(ngModel)]="task.title"
                            [name]="'stage-' + si + '-task-title-' + ti" required />
                        </div>

                        <div class="bp-form-group">
                          <label class="bp-label">Descri√ß√£o</label>
                          <app-rich-text-editor [(ngModel)]="task.description"
                            [name]="'stage-' + si + '-task-desc-' + ti"
                            placeholder="Descreva a tarefa..."></app-rich-text-editor>
                        </div>

                        <!-- Subtarefas -->
                        <div class="bp-mb-md">
                          <div class="bp-flex bp-justify-between bp-items-center bp-mb-sm">
                            <label class="bp-label">Subtarefas</label>
                            <button type="button" class="bp-btn bp-btn-sm bp-btn-secondary"
                              (click)="addSubtaskToStageTask(si, ti)">
                              + Subtarefa
                            </button>
                          </div>

                          <div *ngFor="let subtask of task.subtasks; let sti = index"
                            class="bp-flex bp-gap-sm bp-mb-sm">
                            <input type="text" class="bp-input" [(ngModel)]="subtask.description"
                              [name]="'stage-' + si + '-task-' + ti + '-subtask-' + sti"
                              placeholder="Descri√ß√£o da subtarefa..." />
                            <button type="button" class="bp-btn bp-btn-sm bp-btn-error"
                              (click)="removeSubtaskFromStageTask(si, ti, sti)">
                              ‚úï
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <p *ngIf="stage.tasks.length === 0" class="bp-text-muted"
                      style="text-align: center; padding: 1rem;">
                      Nenhuma tarefa nesta etapa. Clique em "+ Tarefa" para adicionar.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Bot√£o para adicionar nova etapa -->
              <div class="bp-flex bp-justify-center bp-mt-md">
                <button type="button" class="bp-btn bp-btn-primary" (click)="addStage()">
                  + Adicionar Nova Etapa
                </button>
              </div>

              <p *ngIf="templateForm.stages.length === 0" class="bp-text-muted"
                style="text-align: center; padding: 2rem; background: #f9f9f9; border-radius: 8px; margin-top: 1rem;">
                Nenhuma etapa criada. As etapas organizam as tarefas do projeto em fases.<br>
                Clique em "+ Adicionar Nova Etapa" para come√ßar.
              </p>
            </div>

            <div class="bp-flex bp-gap-md">
              <button type="submit" class="bp-btn bp-btn-primary" [disabled]="saving()">
                {{ saving() ? "Salvando..." : (templateId ? "Salvar Altera√ß√µes" : "Criar Template") }}
              </button>
              <button type="button" class="bp-btn bp-btn-secondary" (click)="cancel()">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>